<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>ObraPro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
            background: #0f172a;
            user-select: none;
            -webkit-user-select: none;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .app-container { height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease; }
        .animate-slide-up { animation: slideUp 0.3s ease; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        .ios-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .touch-key {
            min-height: 56px;
            touch-action: manipulation;
            transition: all 0.1s;
            border: none;
            font-weight: 600;
            background: white;
            border-radius: 12px;
        }
        .touch-key:active { transform: scale(0.92); background: #e2e8f0; }
        
        .calc-display {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            font-family: 'SF Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            text-align: right;
            min-height: 64px;
            word-break: break-all;
        }
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 90vh;
            overflow-y: auto;
        }
        .bottom-sheet.open { transform: translateY(0); }
        
        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 199;
        }
        .sheet-overlay.open { opacity: 1; pointer-events: auto; }
        
        .fab {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 100;
            border: none;
        }
        .fab:active { transform: scale(0.9); }
        
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        .toast.warning { background: #f59e0b; }
        
        .obra-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: white;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            border: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .obra-chip.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        input, select, textarea {
            font-size: 16px !important;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6;
            background: white;
        }
        textarea {
            resize: none;
            font-family: inherit;
            min-height: 100px;
        }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .photo-thumb { aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative; background: #f1f5f9; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb .delete {
            position: absolute; top: 4px; right: 4px;
            width: 24px; height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; border: none;
        }
        
        .photo-modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .photo-modal.open { opacity: 1; pointer-events: auto; }
        .photo-modal img { max-width: 90%; max-height: 80vh; border-radius: 12px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 16px; }
        .menu-item {
            aspect-ratio: 1; background: white;
            border-radius: 16px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative;
        }
        .menu-item svg { width: 28px; height: 28px; color: #3b82f6; }
        .menu-item span { font-size: 11px; font-weight: 600; color: #475569; text-align: center; }
        
        .item-actions { display: flex; gap: 8px; }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            border: none; transition: all 0.2s;
        }
        .btn-icon:active { transform: scale(0.9); }
        .btn-edit { background: #dbeafe; color: #2563eb; }
        .btn-delete { background: #fee2e2; color: #dc2626; }
        .btn-copy { background: #dcfce7; color: #16a34a; }
        .btn-share { background: #fef3c7; color: #d97706; }
        .btn-backup { background: #e0e7ff; color: #4338ca; }
        
        .resumen-tabla {
            width: 100%;
            border-collapse: collapse;
        }
        .resumen-tabla th {
            background: #f1f5f9;
            padding: 12px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
        }
        .resumen-tabla td {
            padding: 16px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }
        .resumen-tabla tr:last-child td {
            border-bottom: none;
        }
        .tipo-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .total-row {
            background: #f8fafc;
            font-weight: 700;
        }
        .total-row td {
            border-top: 2px solid #e2e8f0;
            font-size: 16px;
        }
        .euro { color: #059669; font-weight: 600; }
        
        .note-card {
            background: white;
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #3b82f6;
        }
        .note-card.urgent {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .note-card.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        .note-card.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .note-date {
            font-size: 11px;
            color: #94a3b8;
            font-weight: 600;
        }
        .note-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .note-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
        }
        .tag-personal { background: #dbeafe; color: #1e40af; }
        .tag-urgente { background: #fecaca; color: #991b1b; }
        .tag-idea { background: #fde68a; color: #92400e; }
        .tag-pendiente { background: #bbf7d0; color: #166534; }
        
        .export-bar {
            display: flex;
            gap: 8px;
            padding: 12px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .export-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .export-btn:active { transform: scale(0.95); }
        .export-pdf { background: #fee2e2; color: #dc2626; }
        .export-excel { background: #dcfce7; color: #16a34a; }
        .export-copy { background: #dbeafe; color: #2563eb; }
        
        /* Storage indicator */
        .storage-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        .storage-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .storage-fill.safe { background: #10b981; }
        .storage-fill.warning { background: #f59e0b; }
        .storage-fill.danger { background: #ef4444; }
        
        .backup-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .backup-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .backup-btn:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.98);
        }
        
        .file-input-hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root" class="app-container safe-top safe-bottom"></div>
    <div id="toast" class="toast"></div>

    <script>
        window.showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 2500);
        };
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
        
        window.formatEUR = (num) => {
            if (!num || isNaN(num)) return '0,00';
            return parseFloat(num).toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };
        
        window.formatNum = (num) => {
            if (!num || isNaN(num)) return '0,00';
            return parseFloat(num).toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };
        
        window.copyToClipboard = async (text) => {
            try {
                await navigator.clipboard.writeText(text);
                window.showToast('Copiado al portapapeles');
                return true;
            } catch (err) {
                const textArea = document.createElement("textarea");
                textArea.value = text;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    window.showToast('Copiado al portapapeles');
                    return true;
                } catch (err) {
                    window.showToast('Error al copiar', 'error');
                    return false;
                } finally {
                    document.body.removeChild(textArea);
                }
            }
        };
        
        // ========== FUNCIONES DE ALMACENAMIENTO ==========
        window.getStorageInfo = () => {
            let total = 0;
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    total += localStorage[key].length * 2; // UTF-16 = 2 bytes por char
                }
            }
            return {
                used: total,
                total: 5 * 1024 * 1024, // 5MB tÃ­pico de localStorage
                percent: Math.round((total / (5 * 1024 * 1024)) * 100)
            };
        };
        
        window.formatBytes = (bytes) => {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        const DB = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            saveItem: (store, item) => {
                const data = DB.get(store);
                const index = data.findIndex(i => i.id === item.id);
                if (index >= 0) {
                    data[index] = { ...data[index], ...item, updatedAt: Date.now() };
                } else {
                    data.unshift({ ...item, id: item.id || (store + '_' + Date.now()), createdAt: Date.now() });
                }
                DB.set(store, data);
                return item;
            },
            deleteItem: (store, id) => {
                const data = DB.get(store).filter(i => i.id !== id);
                DB.set(store, data);
            },
            // ========== NUEVO: Backup/Restore ==========
            exportAll: () => {
                const backup = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    user: localStorage.getItem('obrapro_user'),
                    data: {
                        obras: DB.get('obras'),
                        mediciones: DB.get('mediciones'),
                        horas: DB.get('horas'),
                        materiales: DB.get('materiales'),
                        personal: DB.get('personal'),
                        gastos: DB.get('gastos'),
                        notas: DB.get('notas'),
                        fotos: DB.get('fotos')
                    }
                };
                return backup;
            },
            importAll: (backup) => {
                if (!backup || !backup.data) throw new Error('Formato invÃ¡lido');
                
                // Validar versiÃ³n (para futuras migraciones)
                if (backup.version !== '1.0') {
                    console.warn('VersiÃ³n de backup diferente:', backup.version);
                }
                
                // Importar todo
                Object.keys(backup.data).forEach(key => {
                    if (Array.isArray(backup.data[key])) {
                        DB.set(key, backup.data[key]);
                    }
                });
                
                // Restaurar usuario si existe
                if (backup.user) {
                    localStorage.setItem('obrapro_user', backup.user);
                }
                
                return true;
            },
            clearAll: () => {
                const keys = ['obras', 'mediciones', 'horas', 'materiales', 'personal', 'gastos', 'notas', 'fotos', 'obrapro_user'];
                keys.forEach(key => localStorage.removeItem(key));
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [obraActual, setObraActual] = useState(null);
            const [obras, setObras] = useState([]);
            const [vista, setVista] = useState('dashboard');
            const [showForm, setShowForm] = useState(false);
            const [showObraForm, setShowObraForm] = useState(false);
            const [showPhotoModal, setShowPhotoModal] = useState(null);
            const [formType, setFormType] = useState('medicion');
            const [editando, setEditando] = useState(null);
            
            const [mediciones, setMediciones] = useState([]);
            const [horas, setHoras] = useState([]);
            const [materiales, setMateriales] = useState([]);
            const [personal, setPersonal] = useState([]);
            const [gastos, setGastos] = useState([]);
            const [notas, setNotas] = useState([]);
            
            const [medForm, setMedForm] = useState({ tipo: 'Tabique', desc: '', valor: '', mult: '', unidad: 'm', precio: '' });
            const [horaForm, setHoraForm] = useState({ desc: '', inicio: '', fin: '', fecha: new Date().toISOString().split('T')[0], descanso: 0, fotos: [] });
            const [obraForm, setObraForm] = useState({ nombre: '', cliente: '', direccion: '', telefono: '', email: '', presupuesto: '' });
            const [matForm, setMatForm] = useState({ nombre: '', cantidad: '', unidad: '', precioUnitario: '', proveedor: '' });
            const [persForm, setPersForm] = useState({ nombre: '', cargo: '', telefono: '', salarioDia: '' });
            const [gastoForm, setGastoForm] = useState({ concepto: '', monto: '', categoria: 'material', fecha: new Date().toISOString().split('T')[0] });
            
            const [showNotaForm, setShowNotaForm] = useState(false);
            const [notaForm, setNotaForm] = useState({ titulo: '', contenido: '', categoria: 'general', prioridad: 'normal' });
            
            // ========== NUEVO: Estados para backup ==========
            const [showBackupModal, setShowBackupModal] = useState(false);
            const [storageInfo, setStorageInfo] = useState({ used: 0, total: 5 * 1024 * 1024, percent: 0 });
            const [lastBackup, setLastBackup] = useState(localStorage.getItem('obrapro_last_backup'));

            // Calcular espacio usado
            const updateStorageInfo = useCallback(() => {
                setStorageInfo(window.getStorageInfo());
            }, []);

            useEffect(() => {
                const savedUser = localStorage.getItem('obrapro_user');
                const savedObras = DB.get('obras');
                
                if (savedUser) setUser(JSON.parse(savedUser));
                setObras(savedObras);
                if (savedObras.length > 0 && !obraActual) {
                    setObraActual(savedObras[0]);
                    cargarDatosObra(savedObras[0].id);
                }
                updateStorageInfo();
                setLoading(false);
                
                // Actualizar info de almacenamiento cada 30 segundos
                const interval = setInterval(updateStorageInfo, 30000);
                return () => clearInterval(interval);
            }, []);

            const cargarDatosObra = (obraId) => {
                setMediciones(DB.get('mediciones').filter(m => m.obraId === obraId));
                setHoras(DB.get('horas').filter(h => h.obraId === obraId));
                setMateriales(DB.get('materiales').filter(m => m.obraId === obraId));
                setPersonal(DB.get('personal').filter(p => p.obraId === obraId));
                setGastos(DB.get('gastos').filter(g => g.obraId === obraId));
                setNotas(DB.get('notas').filter(n => n.obraId === obraId).sort((a, b) => b.createdAt - a.createdAt));
                updateStorageInfo();
            };

            // ========== NUEVO: Funciones de Backup ==========
            const exportarBackup = () => {
                try {
                    const backup = DB.exportAll();
                    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `ObraPro_Backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Guardar fecha del Ãºltimo backup
                    const now = new Date().toISOString();
                    localStorage.setItem('obrapro_last_backup', now);
                    setLastBackup(now);
                    
                    window.showToast('âœ… Backup exportado correctamente');
                } catch (error) {
                    console.error('Error exportando:', error);
                    window.showToast('âŒ Error al exportar', 'error');
                }
            };

            const importarBackup = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                if (!confirm('âš ï¸ Esto REEMPLAZARÃ todos los datos actuales. Â¿EstÃ¡s seguro?')) {
                    event.target.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        DB.importAll(backup);
                        
                        // Recargar todo
                        const savedUser = localStorage.getItem('obrapro_user');
                        if (savedUser) setUser(JSON.parse(savedUser));
                        
                        const savedObras = DB.get('obras');
                        setObras(savedObras);
                        
                        if (savedObras.length > 0) {
                            setObraActual(savedObras[0]);
                            cargarDatosObra(savedObras[0].id);
                        } else {
                            setObraActual(null);
                            setMediciones([]);
                            setHoras([]);
                            setMateriales([]);
                            setPersonal([]);
                            setGastos([]);
                            setNotas([]);
                        }
                        
                        updateStorageInfo();
                        window.showToast('âœ… Backup importado correctamente');
                        setShowBackupModal(false);
                    } catch (error) {
                        console.error('Error importando:', error);
                        window.showToast('âŒ Archivo invÃ¡lido o corrupto', 'error');
                    }
                    event.target.value = '';
                };
                reader.readAsText(file);
            };

            const login = (email, nombre) => {
                const newUser = { id: Date.now(), email, nombre };
                localStorage.setItem('obrapro_user', JSON.stringify(newUser));
                setUser(newUser);
                window.showToast('Â¡Bienvenido!');
            };

            const logout = () => {
                localStorage.removeItem('obrapro_user');
                setUser(null);
            };

            const guardarObra = () => {
                if (!obraForm.nombre) {
                    window.showToast('El nombre es obligatorio', 'error');
                    return;
                }
                const obra = {
                    id: editando?.id || 'obra_' + Date.now(),
                    ...obraForm,
                    fechaCreacion: editando?.fechaCreacion || new Date().toLocaleDateString('es-ES'),
                    updatedAt: Date.now()
                };
                DB.saveItem('obras', obra);
                const nuevasObras = DB.get('obras');
                setObras(nuevasObras);
                setObraActual(obra);
                setShowObraForm(false);
                setEditando(null);
                setObraForm({ nombre: '', cliente: '', direccion: '', telefono: '', email: '', presupuesto: '' });
                updateStorageInfo();
                window.showToast(editando ? 'Obra actualizada' : 'Obra creada');
            };

            const editarObra = (obra) => {
                setEditando(obra);
                setObraForm({
                    nombre: obra.nombre,
                    cliente: obra.cliente || '',
                    direccion: obra.direccion || '',
                    telefono: obra.telefono || '',
                    email: obra.email || '',
                    presupuesto: obra.presupuesto || ''
                });
                setShowObraForm(true);
            };

            const eliminarObra = (obraId) => {
                if (!confirm('Â¿Eliminar esta obra y todos sus datos?')) return;
                DB.deleteItem('obras', obraId);
                ['mediciones', 'horas', 'materiales', 'personal', 'gastos', 'notas'].forEach(tipo => {
                    DB.get(tipo).filter(i => i.obraId === obraId).forEach(i => DB.deleteItem(tipo, i.id));
                });
                const nuevas = DB.get('obras');
                setObras(nuevas);
                setObraActual(nuevas[0] || null);
                if (nuevas[0]) cargarDatosObra(nuevas[0].id);
                updateStorageInfo();
                window.showToast('Obra eliminada');
            };

            const clickTecla = (t) => {
                if (t === 'C') setMedForm(p => ({...p, valor: ''}));
                else if (t === 'â†') setMedForm(p => ({...p, valor: p.valor.slice(0, -1)}));
                else if (t === '+') setMedForm(p => ({...p, valor: p.valor.endsWith('+') ? p.valor : p.valor + '+'}));
                else setMedForm(p => ({...p, valor: p.valor + t}));
            };

            const guardarMedicion = () => {
                if (!obraActual || !medForm.valor) return;
                const suma = medForm.valor.split('+').reduce((a, b) => a + (parseFloat(b) || 0), 0);
                const mult = parseFloat(medForm.mult) || 0;
                const precio = parseFloat(medForm.precio) || 0;
                
                const medicion = {
                    id: editando?.id || 'med_' + Date.now(),
                    obraId: obraActual.id,
                    tipo: medForm.tipo,
                    desc: medForm.desc || 'Sin descripciÃ³n',
                    valor: medForm.valor,
                    mult,
                    unidad: medForm.unidad,
                    totalL: suma.toFixed(2),
                    totalS: (suma * mult).toFixed(2),
                    precio,
                    totalPrecio: (suma * mult * precio).toFixed(2),
                    fecha: editando?.fecha || new Date().toLocaleDateString('es-ES')
                };
                DB.saveItem('mediciones', medicion);
                cargarDatosObra(obraActual.id);
                cerrarFormMedicion();
                updateStorageInfo();
                window.showToast(editando ? 'MediciÃ³n actualizada' : 'MediciÃ³n guardada');
            };

            const editarMedicion = (med) => {
                setEditando(med);
                setMedForm({ tipo: med.tipo, desc: med.desc, valor: med.valor, mult: med.mult, unidad: med.unidad, precio: med.precio });
                setFormType('medicion');
                setShowForm(true);
            };

            const cerrarFormMedicion = () => {
                setShowForm(false);
                setEditando(null);
                setMedForm({ tipo: 'Tabique', desc: '', valor: '', mult: '', unidad: 'm', precio: '' });
            };

            const copiarMedicion = (med) => {
                const texto = `ðŸ“ MEDICIÃ“N - ${obraActual?.nombre || 'Obra'}
                
Tipo: ${med.tipo}
DescripciÃ³n: ${med.desc}
Fecha: ${med.fecha}

ðŸ“ CÃ¡lculo: ${med.valor} ${med.unidad}
ðŸ“Š Metros lineales: ${window.formatNum(med.totalL)} ml
ðŸ“ Metros cuadrados: ${window.formatNum(med.totalS)} mÂ²
${med.precio > 0 ? `ðŸ’° Precio/mÂ²: ${window.formatEUR(med.precio)} â‚¬\nðŸ’µ Total: ${window.formatEUR(med.totalPrecio)} â‚¬` : ''}

_Enviado desde ObraPro_`;

                window.copyToClipboard(texto);
            };

            const guardarNota = () => {
                if (!obraActual || !notaForm.contenido.trim()) {
                    window.showToast('El contenido es obligatorio', 'error');
                    return;
                }
                
                const nota = {
                    id: editando?.id || 'nota_' + Date.now(),
                    obraId: obraActual.id,
                    titulo: notaForm.titulo || 'Sin tÃ­tulo',
                    contenido: notaForm.contenido,
                    categoria: notaForm.categoria,
                    prioridad: notaForm.prioridad,
                    fecha: editando?.fecha || new Date().toLocaleDateString('es-ES'),
                    createdAt: editando?.createdAt || Date.now()
                };
                
                DB.saveItem('notas', nota);
                cargarDatosObra(obraActual.id);
                cerrarFormNota();
                updateStorageInfo();
                window.showToast(editando ? 'Nota actualizada' : 'Nota guardada');
            };

            const editarNota = (nota) => {
                setEditando(nota);
                setNotaForm({
                    titulo: nota.titulo,
                    contenido: nota.contenido,
                    categoria: nota.categoria,
                    prioridad: nota.prioridad
                });
                setShowNotaForm(true);
            };

            const cerrarFormNota = () => {
                setShowNotaForm(false);
                setEditando(null);
                setNotaForm({ titulo: '', contenido: '', categoria: 'general', prioridad: 'normal' });
            };

            const copiarNota = (nota) => {
                const texto = `ðŸ“ NOTA - ${obraActual?.nombre || 'Obra'}

${nota.titulo !== 'Sin tÃ­tulo' ? `ðŸ“Œ ${nota.titulo}\n` : ''}${nota.categoria !== 'general' ? `ðŸ·ï¸ ${nota.categoria.toUpperCase()}\n` : ''}
${nota.contenido}

ðŸ“… ${nota.fecha}

_Enviado desde ObraPro_`;

                window.copyToClipboard(texto);
            };

            const guardarHora = () => {
                if (!obraActual || !horaForm.inicio || !horaForm.fin) return;
                const h1 = new Date(`2000-01-01T${horaForm.inicio}`);
                const h2 = new Date(`2000-01-01T${horaForm.fin}`);
                let horas = (h2 - h1) / 3600000 - (parseFloat(horaForm.descanso) || 0) / 60;
                if (horas <= 0) {
                    window.showToast('Hora fin debe ser mayor', 'error');
                    return;
                }
                const hora = {
                    id: editando?.id || 'hora_' + Date.now(),
                    obraId: obraActual.id,
                    desc: horaForm.desc || 'Sin descripciÃ³n',
                    inicio: horaForm.inicio,
                    fin: horaForm.fin,
                    fecha: horaForm.fecha,
                    descanso: horaForm.descanso,
                    total: horas.toFixed(2),
                    fotos: editando ? editando.fotos : horaForm.fotos.length
                };
                DB.saveItem('horas', hora);
                if (!editando && horaForm.fotos.length > 0) {
                    horaForm.fotos.forEach((foto, i) => {
                        DB.saveItem('fotos', { id: `foto_${hora.id}_${i}`, horaId: hora.id, obraId: obraActual.id, data: foto });
                    });
                }
                cargarDatosObra(obraActual.id);
                cerrarFormHora();
                updateStorageInfo();
                window.showToast(editando ? 'Hora actualizada' : 'Horas guardadas');
            };

            const editarHora = (hora) => {
                setEditando(hora);
                setHoraForm({ desc: hora.desc, inicio: hora.inicio, fin: hora.fin, fecha: hora.fecha, descanso: hora.descanso, fotos: [] });
                setFormType('horas');
                setShowForm(true);
            };

            const cerrarFormHora = () => {
                setShowForm(false);
                setEditando(null);
                setHoraForm({ desc: '', inicio: '', fin: '', fecha: new Date().toISOString().split('T')[0], descanso: 0, fotos: [] });
            };

            const guardarMaterial = () => {
                if (!obraActual || !matForm.nombre) return;
                const material = {
                    id: editando?.id || 'mat_' + Date.now(),
                    obraId: obraActual.id,
                    ...matForm,
                    total: (parseFloat(matForm.cantidad) * parseFloat(matForm.precioUnitario || 0)).toFixed(2),
                    fecha: editando?.fecha || new Date().toLocaleDateString('es-ES')
                };
                DB.saveItem('materiales', material);
                cargarDatosObra(obraActual.id);
                setShowForm(false);
                setEditando(null);
                setMatForm({ nombre: '', cantidad: '', unidad: '', precioUnitario: '', proveedor: '' });
                updateStorageInfo();
                window.showToast(editando ? 'Material actualizado' : 'Material guardado');
            };

            const editarMaterial = (mat) => {
                setEditando(mat);
                setMatForm({ nombre: mat.nombre, cantidad: mat.cantidad, unidad: mat.unidad, precioUnitario: mat.precioUnitario, proveedor: mat.proveedor });
                setFormType('material');
                setShowForm(true);
            };

            const guardarPersonal = () => {
                if (!obraActual || !persForm.nombre) return;
                const person = {
                    id: editando?.id || 'pers_' + Date.now(),
                    obraId: obraActual.id,
                    ...persForm,
                    fechaRegistro: editando?.fechaRegistro || new Date().toLocaleDateString('es-ES')
                };
                DB.saveItem('personal', person);
                cargarDatosObra(obraActual.id);
                setShowForm(false);
                setEditando(null);
                setPersForm({ nombre: '', cargo: '', telefono: '', salarioDia: '' });
                updateStorageInfo();
                window.showToast(editando ? 'Personal actualizado' : 'Personal guardado');
            };

            const editarPersonal = (pers) => {
                setEditando(pers);
                setPersForm({ nombre: pers.nombre, cargo: pers.cargo, telefono: pers.telefono, salarioDia: pers.salarioDia });
                setFormType('personal');
                setShowForm(true);
            };

            const guardarGasto = () => {
                if (!obraActual || !gastoForm.concepto) return;
                const gasto = { id: editando?.id || 'gasto_' + Date.now(), obraId: obraActual.id, ...gastoForm };
                DB.saveItem('gastos', gasto);
                cargarDatosObra(obraActual.id);
                setShowForm(false);
                setEditando(null);
                setGastoForm({ concepto: '', monto: '', categoria: 'material', fecha: new Date().toISOString().split('T')[0] });
                updateStorageInfo();
                window.showToast(editando ? 'Gasto actualizado' : 'Gasto guardado');
            };

            const editarGasto = (gasto) => {
                setEditando(gasto);
                setGastoForm({ concepto: gasto.concepto, monto: gasto.monto, categoria: gasto.categoria, fecha: gasto.fecha });
                setFormType('gasto');
                setShowForm(true);
            };

            const tomarFoto = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onloadend = () => setHoraForm(p => ({...p, fotos: [...p.fotos, reader.result]}));
                    reader.readAsDataURL(file);
                };
                input.click();
            };

            const eliminarFoto = (idx) => setHoraForm(p => ({...p, fotos: p.fotos.filter((_, i) => i !== idx)}));

            const eliminarItem = (tipo, id) => {
                if (!confirm('Â¿Eliminar este registro?')) return;
                DB.deleteItem(tipo, id);
                cargarDatosObra(obraActual.id);
                updateStorageInfo();
                window.showToast('Eliminado');
            };

            const exportarExcel = () => {
                const wb = XLSX.utils.book_new();
                wb.Props = {
                    Title: `ObraPro - ${obraActual?.nombre}`,
                    Subject: "Resumen de obra",
                    Author: "ObraPro",
                    CreatedDate: new Date()
                };

                if (mediciones.length > 0) {
                    const medsWS = XLSX.utils.json_to_sheet(mediciones.map(m => ({
                        Fecha: m.fecha,
                        Tipo: m.tipo,
                        DescripciÃ³n: m.desc,
                        CÃ¡lculo: m.valor,
                        Multiplicador: m.mult,
                        'Metros Lineales': parseFloat(m.totalL),
                        'Metros Cuadrados': parseFloat(m.totalS),
                        'Precio/mÂ²': m.precio,
                        'Total â‚¬': parseFloat(m.totalPrecio || 0)
                    })));
                    XLSX.utils.book_append_sheet(wb, medsWS, "Mediciones");
                }

                if (horas.length > 0) {
                    const horasWS = XLSX.utils.json_to_sheet(horas.map(h => ({
                        Fecha: h.fecha,
                        DescripciÃ³n: h.desc,
                        Inicio: h.inicio,
                        Fin: h.fin,
                        Descanso: h.descanso,
                        'Total Horas': parseFloat(h.total)
                    })));
                    XLSX.utils.book_append_sheet(wb, horasWS, "Horas");
                }

                if (materiales.length > 0) {
                    const matsWS = XLSX.utils.json_to_sheet(materiales.map(m => ({
                        Fecha: m.fecha,
                        Nombre: m.nombre,
                        Cantidad: parseFloat(m.cantidad),
                        Unidad: m.unidad,
                        'Precio Unitario': parseFloat(m.precioUnitario || 0),
                        Proveedor: m.proveedor,
                        'Total â‚¬': parseFloat(m.total || 0)
                    })));
                    XLSX.utils.book_append_sheet(wb, matsWS, "Materiales");
                }

                if (notas.length > 0) {
                    const notasWS = XLSX.utils.json_to_sheet(notas.map(n => ({
                        Fecha: n.fecha,
                        TÃ­tulo: n.titulo,
                        CategorÃ­a: n.categoria,
                        Prioridad: n.prioridad,
                        Contenido: n.contenido
                    })));
                    XLSX.utils.book_append_sheet(wb, notasWS, "Notas");
                }

                const resumenData = [{
                    Concepto: 'Total Metros Lineales',
                    Valor: stats.totalML,
                    Unidad: 'ml'
                }, {
                    Concepto: 'Total Metros Cuadrados',
                    Valor: stats.totalM2,
                    Unidad: 'mÂ²'
                }, {
                    Concepto: 'Total Horas Trabajadas',
                    Valor: stats.totalHoras,
                    Unidad: 'h'
                }, {
                    Concepto: 'Total Materiales',
                    Valor: stats.totalMateriales,
                    Unidad: 'â‚¬'
                }, {
                    Concepto: 'Total Gastos',
                    Valor: stats.totalGastos,
                    Unidad: 'â‚¬'
                }, {
                    Concepto: 'Total Mediciones',
                    Valor: stats.totalPrecio,
                    Unidad: 'â‚¬'
                }];
                
                const resumenWS = XLSX.utils.json_to_sheet(resumenData);
                XLSX.utils.book_append_sheet(wb, resumenWS, "Resumen");

                XLSX.writeFile(wb, `ObraPro_${obraActual?.nombre}_${new Date().toISOString().split('T')[0]}.xlsx`);
                window.showToast('Excel generado');
            };

            const exportarPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFillColor(15, 23, 42);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.text(obraActual?.nombre || 'INFORME', 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 105, 32, { align: 'center' });
                
                let y = 50;
                
                if (mediciones.length > 0) {
                    doc.setFontSize(14);
                    doc.text('MEDICIONES', 14, y);
                    y += 10;
                    doc.autoTable({
                        head: [['Fecha', 'Tipo', 'Descripcion', 'm2', 'Total']],
                        body: mediciones.map(m => [m.fecha, m.tipo, m.desc.substring(0, 25), m.totalS.replace('.', ','), m.totalPrecio ? m.totalPrecio.replace('.', ',') + ' EUR' : '-']),
                        startY: y,
                        theme: 'striped',
                        headStyles: { fillColor: [37, 99, 235] }
                    });
                    y = doc.lastAutoTable.finalY + 15;
                }
                
                if (horas.length > 0) {
                    doc.setFontSize(14);
                    doc.text('HORAS', 14, y);
                    y += 10;
                    doc.autoTable({
                        head: [['Fecha', 'Descripcion', 'Horario', 'Total']],
                        body: horas.map(h => [h.fecha, h.desc.substring(0, 30), `${h.inicio}-${h.fin}`, h.total.replace('.', ',') + 'h']),
                        startY: y,
                        theme: 'striped',
                        headStyles: { fillColor: [16, 185, 129] }
                    });
                }
                
                doc.save(`Obra_${obraActual?.nombre}_${new Date().toISOString().split('T')[0]}.pdf`);
                window.showToast('PDF generado');
            };

            const calcularResumenPorTipo = () => {
                const tipos = ['Tabique', 'Techo', 'CajÃ³n ML', 'Tabica', 'Cantonera', 'Muro', 'Piso'];
                const resumen = [];
                
                tipos.forEach(tipo => {
                    const meds = mediciones.filter(m => m.tipo === tipo);
                    if (meds.length > 0) {
                        const totalML = meds.reduce((a, b) => a + parseFloat(b.totalL), 0);
                        const totalM2 = meds.reduce((a, b) => a + parseFloat(b.totalS), 0);
                        const totalPrecio = meds.reduce((a, b) => a + parseFloat(b.totalPrecio || 0), 0);
                        
                        resumen.push({
                            tipo,
                            cantidad: meds.length,
                            ml: totalML,
                            m2: totalM2,
                            precio: totalPrecio,
                            color: getColorTipo(tipo)
                        });
                    }
                });
                
                return resumen;
            };

            const getColorTipo = (tipo) => {
                const colores = {
                    'Tabique': 'bg-orange-100 text-orange-700',
                    'Techo': 'bg-blue-100 text-blue-700',
                    'CajÃ³n ML': 'bg-purple-100 text-purple-700',
                    'Tabica': 'bg-green-100 text-green-700',
                    'Cantonera': 'bg-pink-100 text-pink-700',
                    'Muro': 'bg-red-100 text-red-700',
                    'Piso': 'bg-amber-100 text-amber-700'
                };
                return colores[tipo] || 'bg-gray-100 text-gray-700';
            };

            const getColorPrioridad = (prioridad) => {
                const colores = {
                    'normal': 'note-card',
                    'urgente': 'note-card urgent',
                    'importante': 'note-card warning',
                    'baja': 'note-card success'
                };
                return colores[prioridad] || 'note-card';
            };

            const getTagClass = (categoria) => {
                const clases = {
                    'personal': 'tag-personal',
                    'urgente': 'tag-urgente',
                    'idea': 'tag-idea',
                    'pendiente': 'tag-pendiente'
                };
                return clases[categoria] || 'bg-slate-100 text-slate-600';
            };

            const resumenPorTipo = calcularResumenPorTipo();
            
            const stats = {
                totalML: mediciones.reduce((a, b) => a + parseFloat(b.totalL), 0),
                totalM2: mediciones.reduce((a, b) => a + parseFloat(b.totalS), 0),
                totalPrecio: mediciones.reduce((a, b) => a + parseFloat(b.totalPrecio || 0), 0),
                totalHoras: horas.reduce((a, b) => a + parseFloat(b.total), 0),
                totalMateriales: materiales.reduce((a, b) => a + parseFloat(b.total || 0), 0),
                totalGastos: gastos.reduce((a, b) => a + parseFloat(b.monto || 0), 0)
            };

            // Formatear fecha del Ãºltimo backup
            const formatLastBackup = () => {
                if (!lastBackup) return 'Nunca';
                const date = new Date(lastBackup);
                const now = new Date();
                const diff = (now - date) / 1000; // segundos
                
                if (diff < 60) return 'Hace un momento';
                if (diff < 3600) return `Hace ${Math.floor(diff/60)} min`;
                if (diff < 86400) return `Hace ${Math.floor(diff/3600)} h`;
                return date.toLocaleDateString('es-ES');
            };

            if (loading) {
                return (
                    <div className="flex-1 flex items-center justify-center text-white">
                        <div className="text-center">
                            <div className="w-20 h-20 bg-blue-500 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                                <span className="text-3xl font-black">OP</span>
                            </div>
                            <p className="font-bold text-lg">ObraPro</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen onLogin={login} />;
            }

            return (
                <>
                    <header className="bg-slate-900 text-white px-4 py-3">
                        <div className="flex justify-between items-center mb-3">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center">
                                    <span className="font-black text-lg">OP</span>
                                </div>
                                <div>
                                    <h1 className="font-black text-sm">ObraPro</h1>
                                    <p className="text-xs text-slate-400">Buen Camino</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {/* BotÃ³n de backup rÃ¡pido en header */}
                                <button onClick={() => setShowBackupModal(true)} className="p-2 bg-slate-800 rounded-lg text-xs flex items-center gap-1">
                                    ðŸ’¾
                                    {storageInfo.percent > 80 && <span className="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>}
                                </button>
                                <button onClick={logout} className="text-xs text-slate-400">Salir</button>
                            </div>
                        </div>
                        
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            {obras.map(o => (
                                <div key={o.id} className="relative group">
                                    <button onClick={() => { setObraActual(o); cargarDatosObra(o.id); }} className={`obra-chip ${obraActual?.id === o.id ? 'active' : ''}`}>
                                        {o.nombre}
                                    </button>
                                    {obraActual?.id === o.id && (
                                        <button onClick={(e) => { e.stopPropagation(); editarObra(o); }} className="absolute -top-1 -right-1 w-5 h-5 bg-amber-400 text-white rounded-full text-xs flex items-center justify-center shadow-md">âœï¸</button>
                                    )}
                                </div>
                            ))}
                            <button onClick={() => { setEditando(null); setObraForm({ nombre: '', cliente: '', direccion: '', telefono: '', email: '', presupuesto: '' }); setShowObraForm(true); }} className="obra-chip bg-slate-800 text-slate-400 border-slate-700 text-xs">+ Nueva</button>
                        </div>
                    </header>

                    {vista === 'dashboard' && (
                        <main className="flex-1 overflow-y-auto no-scrollbar p-4">
                            {!obraActual ? (
                                <div className="text-center text-white py-20">
                                    <p className="mb-4">Crea tu primera obra</p>
                                    <button onClick={() => setShowObraForm(true)} className="px-6 py-3 bg-blue-600 rounded-xl font-bold">Crear Obra</button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    {/* ========== NUEVO: Tarjeta de Backup ========== */}
                                    <div className="backup-card">
                                        <div className="flex justify-between items-start mb-3">
                                            <div>
                                                <h3 className="font-bold text-lg">ðŸ’¾ Backup de Datos</h3>
                                                <p className="text-sm opacity-90">Ãšltimo: {formatLastBackup()}</p>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs opacity-75">Almacenamiento</p>
                                                <p className="font-bold">{window.formatBytes(storageInfo.used)} / 5 MB</p>
                                            </div>
                                        </div>
                                        
                                        {/* Barra de progreso del almacenamiento */}
                                        <div className="storage-bar mb-4">
                                            <div 
                                                className={`storage-fill ${storageInfo.percent > 90 ? 'danger' : storageInfo.percent > 70 ? 'warning' : 'safe'}`}
                                                style={{width: `${Math.min(storageInfo.percent, 100)}%`}}
                                            ></div>
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            <button onClick={exportarBackup} className="backup-btn flex-1">
                                                ðŸ“¥ Exportar Backup
                                            </button>
                                            <button onClick={() => document.getElementById('import-file').click()} className="backup-btn flex-1">
                                                ðŸ“¤ Importar Backup
                                            </button>
                                            <input 
                                                type="file" 
                                                id="import-file" 
                                                accept=".json" 
                                                className="file-input-hidden"
                                                onChange={importarBackup}
                                            />
                                        </div>
                                        {storageInfo.percent > 80 && (
                                            <p className="text-xs mt-2 text-yellow-200">
                                                âš ï¸ Espacio bajo. Exporta y limpia fotos antiguas.
                                            </p>
                                        )}
                                    </div>

                                    <div className="ios-card p-4 bg-gradient-to-br from-blue-600 to-purple-600 text-white">
                                        <div className="flex justify-between items-start mb-2">
                                            <div>
                                                <p className="text-xs text-blue-200 mb-1">{obraActual.nombre}</p>
                                                <p className="text-sm opacity-90">{obraActual.cliente}</p>
                                                <p className="text-xs opacity-75">{obraActual.direccion}</p>
                                            </div>
                                            <button onClick={() => editarObra(obraActual)} className="p-2 bg-white/20 rounded-lg text-xs">âœï¸ Editar</button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 mt-3 pt-3 border-t border-white/20">
                                            <div>
                                                <p className="text-2xl font-black">{window.formatNum(stats.totalML)} <span className="text-sm">ml</span></p>
                                                <p className="text-xs text-blue-200">metros lineales</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-black">{window.formatNum(stats.totalHoras)}<span className="text-sm">h</span></p>
                                                <p className="text-xs text-blue-200">horas trabajadas</p>
                                            </div>
                                        </div>
                                        {stats.totalPrecio > 0 && (
                                            <p className="mt-3 pt-3 border-t border-white/20 text-lg font-bold">{window.formatEUR(stats.totalPrecio)} â‚¬</p>
                                        )}
                                    </div>

                                    <div className="export-bar bg-white rounded-2xl mx-[-4px]">
                                        <button onClick={exportarPDF} className="export-btn export-pdf">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                            PDF
                                        </button>
                                        <button onClick={exportarExcel} className="export-btn export-excel">
                                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                                            Excel
                                        </button>
                                    </div>

                                    <div className="menu-grid">
                                        <div className="menu-item" onClick={() => setVista('mediciones')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                            <span>Mediciones</span>
                                            {mediciones.length > 0 && <span className="absolute top-1 right-1 bg-blue-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{mediciones.length}</span>}
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('horas')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                            <span>Horas</span>
                                            {horas.length > 0 && <span className="absolute top-1 right-1 bg-emerald-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{horas.length}</span>}
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('materiales')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                                            <span>Materiales</span>
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('personal')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                            <span>Personal</span>
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('gastos')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                            <span>Gastos</span>
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('resumen')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                            <span>Resumen</span>
                                            {resumenPorTipo.length > 0 && <span className="absolute top-1 right-1 bg-purple-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">ðŸ“Š</span>}
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('notas')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                            <span>Notas</span>
                                            {notas.length > 0 && <span className="absolute top-1 right-1 bg-amber-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{notas.length}</span>}
                                        </div>
                                    </div>

                                    {mediciones.length > 0 && (
                                        <div className="ios-card p-4">
                                            <h3 className="text-sm font-bold text-slate-500 mb-3">Ãšltimas mediciones</h3>
                                            {mediciones.slice(0, 3).map(m => (
                                                <div key={m.id} className="flex justify-between items-center py-2 border-b last:border-0">
                                                    <div>
                                                        <span className="text-xs font-bold text-blue-500">{m.tipo}</span>
                                                        <p className="text-sm font-medium">{m.desc}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-bold">{window.formatNum(m.totalL)} ml</p>
                                                        <p className="text-xs text-emerald-600">{window.formatNum(m.totalS)} mÂ²</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}

                                    {notas.length > 0 && (
                                        <div className="ios-card p-4">
                                            <h3 className="text-sm font-bold text-slate-500 mb-3">ðŸ“ Notas recientes</h3>
                                            {notas.slice(0, 2).map(n => (
                                                <div key={n.id} className="mb-2 last:mb-0 p-3 bg-slate-50 rounded-xl border-l-4 border-amber-400">
                                                    <p className="font-bold text-sm text-slate-800">{n.titulo}</p>
                                                    <p className="text-xs text-slate-500 line-clamp-2">{n.contenido}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>
                    )}

                    {vista === 'notas' && (
                        <main className="flex-1 overflow-y-auto no-scrollbar p-4 bg-slate-100">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-4">
                                    <button onClick={() => setVista('dashboard')} className="p-2 bg-white rounded-full">â†</button>
                                    <h2 className="text-xl font-bold text-slate-800">ðŸ“ Notas RÃ¡pidas</h2>
                                </div>
                                <button onClick={() => { setEditando(null); setNotaForm({ titulo: '', contenido: '', categoria: 'general', prioridad: 'normal' }); setShowNotaForm(true); }} className="px-4 py-2 bg-amber-500 text-white rounded-full text-sm font-bold">
                                    + Nueva
                                </button>
                            </div>

                            {notas.length === 0 ? (
                                <div className="text-center text-slate-400 py-10">
                                    <p className="text-4xl mb-2">ðŸ“</p>
                                    <p>No hay notas aÃºn</p>
                                    <p className="text-sm mt-2">Crea tu primera nota para recordar detalles importantes</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {notas.map(nota => (
                                        <div key={nota.id} className={getColorPrioridad(nota.prioridad)}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <h3 className="font-bold text-slate-800">{nota.titulo}</h3>
                                                        {nota.categoria !== 'general' && (
                                                            <span className={getTagClass(nota.categoria)}>
                                                                {nota.categoria}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p className="note-date">{nota.fecha}</p>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => copiarNota(nota)} className="btn-icon btn-copy" title="Copiar">ðŸ“‹</button>
                                                    <button onClick={() => editarNota(nota)} className="btn-icon btn-edit" title="Editar">âœï¸</button>
                                                    <button onClick={() => eliminarItem('notas', nota.id)} className="btn-icon btn-delete" title="Eliminar">ðŸ—‘ï¸</button>
                                                </div>
                                            </div>
                                            <p className="text-slate-700 text-sm whitespace-pre-wrap">{nota.contenido}</p>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    )}

                    {vista === 'resumen' && (
                        <main className="flex-1 overflow-y-auto no-scrollbar p-4 bg-slate-100">
                            <div className="flex items-center gap-4 mb-4">
                                <button onClick={() => setVista('dashboard')} className="p-2 bg-white rounded-full">â†</button>
                                <h2 className="text-xl font-bold text-slate-800">ðŸ“Š Resumen por Tipo</h2>
                            </div>

                            {resumenPorTipo.length === 0 ? (
                                <div className="text-center text-slate-400 py-10">
                                    <p>No hay mediciones registradas</p>
                                    <button onClick={() => setVista('mediciones')} className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">Agregar mediciÃ³n</button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="ios-card overflow-hidden">
                                        <table className="resumen-tabla">
                                            <thead>
                                                <tr>
                                                    <th>Tipo</th>
                                                    <th className="text-right">Regs.</th>
                                                    <th className="text-right">Metros</th>
                                                    <th className="text-right">mÂ²</th>
                                                    <th className="text-right">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {resumenPorTipo.map(item => (
                                                    <tr key={item.tipo} className="animate-fade-in">
                                                        <td>
                                                            <span className={`tipo-badge ${item.color}`}>
                                                                {item.tipo}
                                                            </span>
                                                        </td>
                                                        <td className="text-right text-slate-600">{item.cantidad}</td>
                                                        <td className="text-right font-mono">{window.formatNum(item.ml)} ml</td>
                                                        <td className="text-right font-mono font-medium">{window.formatNum(item.m2)} mÂ²</td>
                                                        <td className="text-right euro">{window.formatEUR(item.precio)} â‚¬</td>
                                                    </tr>
                                                ))}
                                                <tr className="total-row">
                                                    <td colSpan="2">TOTALES</td>
                                                    <td className="text-right font-mono text-blue-600">{window.formatNum(stats.totalML)} ml</td>
                                                    <td className="text-right font-mono text-blue-600">{window.formatNum(stats.totalM2)} mÂ²</td>
                                                    <td className="text-right text-emerald-600 text-lg">{window.formatEUR(stats.totalPrecio)} â‚¬</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3">
                                        {resumenPorTipo.map(item => (
                                            <div key={item.tipo} className="ios-card p-3">
                                                <div className={`inline-block px-2 py-1 rounded text-xs font-bold mb-2 ${item.color}`}>
                                                    {item.tipo}
                                                </div>
                                                <p className="text-2xl font-black text-slate-800">{window.formatNum(item.m2)} <span className="text-sm font-normal">mÂ²</span></p>
                                                <p className="text-xs text-slate-500">{window.formatNum(item.ml)} ml â€¢ {item.cantidad} regs.</p>
                                                <p className="text-sm font-bold text-emerald-600 mt-1">{window.formatEUR(item.precio)} â‚¬</p>
                                            </div>
                                        ))}
                                    </div>

                                    {obraActual?.presupuesto && (
                                        <div className="ios-card p-4 bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200">
                                            <h3 className="text-sm font-bold text-amber-800 mb-2">ðŸ“ˆ ComparaciÃ³n con Presupuesto</h3>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm text-amber-700">Presupuesto:</span>
                                                <span className="font-bold text-amber-900">{window.formatEUR(parseFloat(obraActual.presupuesto))} â‚¬</span>
                                            </div>
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="text-sm text-amber-700">Ejecutado:</span>
                                                <span className="font-bold text-amber-900">{window.formatEUR(stats.totalPrecio)} â‚¬</span>
                                            </div>
                                            <div className="w-full bg-amber-200 rounded-full h-3 mt-2">
                                                <div 
                                                    className="bg-amber-500 h-3 rounded-full transition-all"
                                                    style={{width: `${Math.min((stats.totalPrecio / parseFloat(obraActual.presupuesto)) * 100, 100)}%`}}
                                                ></div>
                                            </div>
                                            <p className="text-xs text-amber-600 mt-1 text-center">
                                                {((stats.totalPrecio / parseFloat(obraActual.presupuesto)) * 100).toFixed(1)}% ejecutado
                                            </p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>
                    )}

                    {vista === 'mediciones' && (
                        <VistaLista titulo="Mediciones" items={mediciones} onBack={() => setVista('dashboard')} onEdit={editarMedicion} onDelete={(id) => eliminarItem('mediciones', id)} renderItem={m => (
                            <>
                                <div className="flex-1">
                                    <span className="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded">{m.tipo}</span>
                                    <p className="font-medium text-sm mt-1">{m.desc}</p>
                                    <p className="text-xs text-slate-400">{m.fecha}</p>
                                </div>
                                <div className="text-right mr-2">
                                    <p className="font-bold text-lg">{window.formatNum(m.totalL)} ml</p>
                                    <p className="text-xs text-emerald-600">{window.formatNum(m.totalS)} mÂ²</p>
                                    {m.precio > 0 && <p className="text-xs text-amber-600">{window.formatEUR(m.totalPrecio)} â‚¬</p>}
                                </div>
                                <button onClick={(e) => { e.stopPropagation(); copiarMedicion(m); }} className="btn-icon btn-copy mr-1" title="Copiar mediciÃ³n">ðŸ“‹</button>
                            </>
                        )} />
                    )}

                    {vista === 'horas' && (
                        <VistaLista titulo="Horas Trabajadas" items={horas} onBack={() => setVista('dashboard')} onEdit={editarHora} onDelete={(id) => eliminarItem('horas', id)} renderItem={h => (
                            <>
                                <div>
                                    <p className="font-medium">{h.desc}</p>
                                    <p className="text-xs text-slate-400">{h.fecha} â€¢ {h.inicio}-{h.fin}</p>
                                    {h.fotos > 0 && <p className="text-xs text-blue-500 mt-1">ðŸ“· {h.fotos} fotos</p>}
                                </div>
                                <p className="font-bold text-emerald-600 text-xl">{window.formatNum(h.total)}h</p>
                            </>
                        )} />
                    )}

                    {vista === 'materiales' && (
                        <VistaLista titulo="Materiales" items={materiales} onBack={() => setVista('dashboard')} onEdit={editarMaterial} onDelete={(id) => eliminarItem('materiales', id)} renderItem={m => (
                            <>
                                <div>
                                    <p className="font-medium">{m.nombre}</p>
                                    <p className="text-xs text-slate-400">{m.cantidad} {m.unidad} â€¢ {m.proveedor}</p>
                                </div>
                                <p className="font-bold">{window.formatEUR(m.total)} â‚¬</p>
                            </>
                        )} />
                    )}

                    {vista === 'personal' && (
                        <VistaLista titulo="Personal" items={personal} onBack={() => setVista('dashboard')} onEdit={editarPersonal} onDelete={(id) => eliminarItem('personal', id)} renderItem={p => (
                            <>
                                <div>
                                    <p className="font-medium">{p.nombre}</p>
                                    <p className="text-xs text-slate-400">{p.cargo} â€¢ {p.telefono}</p>
                                </div>
                                <p className="text-sm font-bold text-blue-600">{window.formatEUR(p.salarioDia)} â‚¬/dÃ­a</p>
                            </>
                        )} />
                    )}

                    {vista === 'gastos' && (
                        <VistaLista titulo="Gastos" items={gastos} onBack={() => setVista('dashboard')} onEdit={editarGasto} onDelete={(id) => eliminarItem('gastos', id)} renderItem={g => (
                            <>
                                <div>
                                    <p className="font-medium">{g.concepto}</p>
                                    <p className="text-xs text-slate-400">{g.fecha} â€¢ {g.categoria}</p>
                                </div>
                                <p className="font-bold text-red-500">-{window.formatEUR(g.monto)} â‚¬</p>
                            </>
                        )} />
                    )}

                    {obraActual && vista === 'dashboard' && (
                        <button onClick={() => { setEditando(null); setShowForm(true); }} className="fab">
                            <svg width="24" height="24" fill="none" stroke="white" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                    )}

                    {/* Modales */}
                    <div className={`sheet-overlay ${showObraForm ? 'open' : ''}`} onClick={() => setShowObraForm(false)}></div>
                    <div className={`bottom-sheet ${showObraForm ? 'open' : ''}`}>
                        <div className="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-4"></div>
                        <h2 className="text-xl font-bold mb-4">{editando ? 'Editar Obra' : 'Nueva Obra'}</h2>
                        <div className="space-y-3">
                            <input placeholder="Nombre *" value={obraForm.nombre} onChange={e => setObraForm({...obraForm, nombre: e.target.value})} />
                            <input placeholder="Cliente" value={obraForm.cliente} onChange={e => setObraForm({...obraForm, cliente: e.target.value})} />
                            <input placeholder="DirecciÃ³n" value={obraForm.direccion} onChange={e => setObraForm({...obraForm, direccion: e.target.value})} />
                            <input placeholder="TelÃ©fono" value={obraForm.telefono} onChange={e => setObraForm({...obraForm, telefono: e.target.value})} />
                            <input placeholder="Email" type="email" value={obraForm.email} onChange={e => setObraForm({...obraForm, email: e.target.value})} />
                            <input placeholder="Presupuesto â‚¬" type="number" value={obraForm.presupuesto} onChange={e => setObraForm({...obraForm, presupuesto: e.target.value})} />
                            <div className="flex gap-2">
                                {editando && <button onClick={() => { eliminarObra(editando.id); setShowObraForm(false); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                <button onClick={guardarObra} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'CREAR OBRA'}</button>
                            </div>
                        </div>
                    </div>

                    <div className={`sheet-overlay ${showForm ? 'open' : ''}`} onClick={() => setShowForm(false)}></div>
                    <div className={`bottom-sheet ${showForm ? 'open' : ''}`}>
                        <div className="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-4"></div>
                        <div className="flex gap-2 mb-4 overflow-x-auto">
                            {['medicion', 'horas', 'material', 'personal', 'gasto'].map(t => (
                                <button key={t} onClick={() => setFormType(t)} className={`px-3 py-2 rounded-full text-xs font-bold capitalize ${formType === t ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'}`}>{t}</button>
                            ))}
                        </div>

                        {formType === 'medicion' && (
                            <div className="space-y-3">
                                <select value={medForm.tipo} onChange={e => setMedForm({...medForm, tipo: e.target.value})} className="font-bold">
                                    <option>Tabique</option><option>Techo</option><option>CajÃ³n ML</option><option>Tabica</option><option>Cantonera</option><option>Muro</option><option>Piso</option>
                                </select>
                                <input placeholder="DescripciÃ³n" value={medForm.desc} onChange={e => setMedForm({...medForm, desc: e.target.value})} />
                                <div className="calc-display">{medForm.valor || "0"} {medForm.unidad}</div>
                                <div className="grid grid-cols-4 gap-2">
                                    {['7','8','9','+','4','5','6','â†','1','2','3','C','.','0'].map(t => (
                                        <button key={t} onClick={() => clickTecla(t)} className={`touch-key ${['+','â†','C'].includes(t) ? 'bg-slate-200' : ''}`}>{t === 'â†' ? 'âŒ«' : t}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input placeholder="Altura/Ancho" type="number" value={medForm.mult} onChange={e => setMedForm({...medForm, mult: e.target.value})} />
                                    <input placeholder="Precio/mÂ² â‚¬" type="number" value={medForm.precio} onChange={e => setMedForm({...medForm, precio: e.target.value})} />
                                </div>
                                <div className="flex gap-2">
                                    {editando && <button onClick={() => { eliminarItem('mediciones', editando.id); cerrarFormMedicion(); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                    <button onClick={guardarMedicion} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'GUARDAR'}</button>
                                </div>
                            </div>
                        )}

                        {formType === 'horas' && (
                            <div className="space-y-3">
                                <input placeholder="DescripciÃ³n" value={horaForm.desc} onChange={e => setHoraForm({...horaForm, desc: e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="time" value={horaForm.inicio} onChange={e => setHoraForm({...horaForm, inicio: e.target.value})} />
                                    <input type="time" value={horaForm.fin} onChange={e => setHoraForm({...horaForm, fin: e.target.value})} />
                                </div>
                                <input type="number" placeholder="Descanso (min)" value={horaForm.descanso} onChange={e => setHoraForm({...horaForm, descanso: e.target.value})} />
                                {!editando && horaForm.fotos.length > 0 && (
                                    <div className="photo-grid">
                                        {horaForm.fotos.map((f, i) => (
                                            <div key={i} className="photo-thumb"><img src={f} /><button onClick={() => eliminarFoto(i)} className="delete">Ã—</button></div>
                                        ))}
                                    </div>
                                )}
                                {!editando && <button onClick={tomarFoto} className="w-full py-3 bg-amber-500 text-white font-bold rounded-xl">ðŸ“· {horaForm.fotos.length > 0 ? 'Agregar foto' : 'Tomar foto'}</button>}
                                <div className="flex gap-2">
                                    {editando && <button onClick={() => { eliminarItem('horas', editando.id); cerrarFormHora(); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                    <button onClick={guardarHora} className="flex-1 py-3 bg-emerald-600 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'GUARDAR HORAS'}</button>
                                </div>
                            </div>
                        )}

                        {formType === 'material' && (
                            <div className="space-y-3">
                                <input placeholder="Nombre" value={matForm.nombre} onChange={e => setMatForm({...matForm, nombre: e.target.value})} />
                                <div className="flex gap-2">
                                    <input placeholder="Cantidad" type="number" value={matForm.cantidad} onChange={e => setMatForm({...matForm, cantidad: e.target.value})} />
                                    <input placeholder="Unidad" value={matForm.unidad} onChange={e => setMatForm({...matForm, unidad: e.target.value})} className="w-24" />
                                </div>
                                <input placeholder="Precio unitario â‚¬" type="number" value={matForm.precioUnitario} onChange={e => setMatForm({...matForm, precioUnitario: e.target.value})} />
                                <input placeholder="Proveedor" value={matForm.proveedor} onChange={e => setMatForm({...matForm, proveedor: e.target.value})} />
                                <div className="flex gap-2">
                                    {editando && <button onClick={() => { eliminarItem('materiales', editando.id); setShowForm(false); setEditando(null); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                    <button onClick={guardarMaterial} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'GUARDAR'}</button>
                                </div>
                            </div>
                        )}

                        {formType === 'personal' && (
                            <div className="space-y-3">
                                <input placeholder="Nombre" value={persForm.nombre} onChange={e => setPersForm({...persForm, nombre: e.target.value})} />
                                <input placeholder="Cargo" value={persForm.cargo} onChange={e => setPersForm({...persForm, cargo: e.target.value})} />
                                <input placeholder="TelÃ©fono" value={persForm.telefono} onChange={e => setPersForm({...persForm, telefono: e.target.value})} />
                                <input placeholder="Salario/dÃ­a â‚¬" type="number" value={persForm.salarioDia} onChange={e => setPersForm({...persForm, salarioDia: e.target.value})} />
                                <div className="flex gap-2">
                                    {editando && <button onClick={() => { eliminarItem('personal', editando.id); setShowForm(false); setEditando(null); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                    <button onClick={guardarPersonal} className="flex-1 py-3 bg-blue-600 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'GUARDAR'}</button>
                                </div>
                            </div>
                        )}

                        {formType === 'gasto' && (
                            <div className="space-y-3">
                                <input placeholder="Concepto" value={gastoForm.concepto} onChange={e => setGastoForm({...gastoForm, concepto: e.target.value})} />
                                <input placeholder="Monto â‚¬" type="number" value={gastoForm.monto} onChange={e => setGastoForm({...gastoForm, monto: e.target.value})} />
                                <select value={gastoForm.categoria} onChange={e => setGastoForm({...gastoForm, categoria: e.target.value})}>
                                    <option value="material">Material</option>
                                    <option value="transporte">Transporte</option>
                                    <option value="comida">Comida</option>
                                    <option value="herramienta">Herramienta</option>
                                    <option value="otro">Otro</option>
                                </select>
                                <div className="flex gap-2">
                                    {editando && <button onClick={() => { eliminarItem('gastos', editando.id); setShowForm(false); setEditando(null); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                    <button onClick={guardarGasto} className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'GUARDAR GASTO'}</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Modal para Notas */}
                    <div className={`sheet-overlay ${showNotaForm ? 'open' : ''}`} onClick={() => setShowNotaForm(false)}></div>
                    <div className={`bottom-sheet ${showNotaForm ? 'open' : ''}`}>
                        <div className="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-4"></div>
                        <h2 className="text-xl font-bold mb-4">{editando ? 'Editar Nota' : 'Nueva Nota RÃ¡pida'}</h2>
                        <div className="space-y-3">
                            <input placeholder="TÃ­tulo (opcional)" value={notaForm.titulo} onChange={e => setNotaForm({...notaForm, titulo: e.target.value})} />
                            <textarea placeholder="Escribe tu nota aquÃ­..." value={notaForm.contenido} onChange={e => setNotaForm({...notaForm, contenido: e.target.value})} />
                            <div className="grid grid-cols-2 gap-2">
                                <select value={notaForm.categoria} onChange={e => setNotaForm({...notaForm, categoria: e.target.value})}>
                                    <option value="general">General</option>
                                    <option value="personal">ðŸ‘¤ Personal</option>
                                    <option value="urgente">ðŸš¨ Urgente</option>
                                    <option value="idea">ðŸ’¡ Idea</option>
                                    <option value="pendiente">â³ Pendiente</option>
                                </select>
                                <select value={notaForm.prioridad} onChange={e => setNotaForm({...notaForm, prioridad: e.target.value})}>
                                    <option value="normal">Normal</option>
                                    <option value="baja">Baja</option>
                                    <option value="importante">Importante</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                            <div className="flex gap-2">
                                {editando && <button onClick={() => { eliminarItem('notas', editando.id); cerrarFormNota(); }} className="flex-1 py-3 bg-red-100 text-red-600 font-bold rounded-xl">ðŸ—‘ï¸ Eliminar</button>}
                                <button onClick={guardarNota} className="flex-1 py-3 bg-amber-500 text-white font-bold rounded-xl">{editando ? 'ðŸ’¾ GUARDAR' : 'GUARDAR NOTA'}</button>
                            </div>
                        </div>
                    </div>

                    {/* ========== NUEVO: Modal de Backup Detallado ========== */}
                    <div className={`sheet-overlay ${showBackupModal ? 'open' : ''}`} onClick={() => setShowBackupModal(false)}></div>
                    <div className={`bottom-sheet ${showBackupModal ? 'open' : ''}`}>
                        <div className="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-4"></div>
                        <h2 className="text-xl font-bold mb-4">ðŸ’¾ GestiÃ³n de Backup</h2>
                        
                        <div className="space-y-4">
                            <div className="bg-slate-50 p-4 rounded-xl">
                                <h3 className="font-bold text-sm mb-2">Estado del Almacenamiento</h3>
                                <div className="flex justify-between text-sm mb-1">
                                    <span className="text-slate-600">Usado:</span>
                                    <span className="font-bold">{window.formatBytes(storageInfo.used)}</span>
                                </div>
                                <div className="flex justify-between text-sm mb-2">
                                    <span className="text-slate-600">Disponible:</span>
                                    <span className="font-bold">{window.formatBytes(storageInfo.total - storageInfo.used)}</span>
                                </div>
                                <div className="storage-bar">
                                    <div 
                                        className={`storage-fill ${storageInfo.percent > 90 ? 'danger' : storageInfo.percent > 70 ? 'warning' : 'safe'}`}
                                        style={{width: `${Math.min(storageInfo.percent, 100)}%`}}
                                    ></div>
                                </div>
                                <p className="text-xs text-slate-500 mt-1">{storageInfo.percent}% usado</p>
                            </div>

                            <div className="bg-blue-50 p-4 rounded-xl">
                                <h3 className="font-bold text-sm mb-2 text-blue-900">ðŸ“Š Resumen de Datos</h3>
                                <div className="grid grid-cols-2 gap-2 text-sm">
                                    <div className="flex justify-between"><span>Obras:</span> <span className="font-bold">{obras.length}</span></div>
                                    <div className="flex justify-between"><span>Mediciones:</span> <span className="font-bold">{mediciones.length}</span></div>
                                    <div className="flex justify-between"><span>Horas:</span> <span className="font-bold">{horas.length}</span></div>
                                    <div className="flex justify-between"><span>Materiales:</span> <span className="font-bold">{materiales.length}</span></div>
                                    <div className="flex justify-between"><span>Notas:</span> <span className="font-bold">{notas.length}</span></div>
                                </div>
                            </div>

                            <div className="space-y-2">
                                <button onClick={exportarBackup} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl flex items-center justify-center gap-2">
                                    <span>ðŸ“¥</span> Exportar Backup Completo
                                </button>
                                
                                <label className="w-full py-3 bg-white border-2 border-indigo-600 text-indigo-600 font-bold rounded-xl flex items-center justify-center gap-2 cursor-pointer">
                                    <span>ðŸ“¤</span> Importar Backup
                                    <input 
                                        type="file" 
                                        accept=".json" 
                                        className="file-input-hidden"
                                        onChange={importarBackup}
                                    />
                                </label>
                                
                                <button onClick={() => {
                                    if (confirm('âš ï¸ Â¿Eliminar TODOS los datos? Esta acciÃ³n no se puede deshacer.')) {
                                        DB.clearAll();
                                        window.location.reload();
                                    }
                                }} className="w-full py-3 bg-red-100 text-red-600 font-bold rounded-xl">
                                    ðŸ—‘ï¸ Borrar Todos los Datos
                                </button>
                            </div>

                            <p className="text-xs text-slate-500 text-center">
                                ðŸ’¡ Consejo: Exporta tu backup semanalmente y guÃ¡rdalo en la nube.
                            </p>
                        </div>
                    </div>

                    <div className={`photo-modal ${showPhotoModal ? 'open' : ''}`} onClick={() => setShowPhotoModal(null)}>
                        <button className="absolute top-4 right-4 text-white p-2 bg-black/50 rounded-full">âœ•</button>
                        {showPhotoModal && <img src={showPhotoModal} />}
                    </div>
                </>
            );
        }

        function LoginScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [nombre, setNombre] = useState('');
            const [isLogin, setIsLogin] = useState(true);

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, nombre || email.split('@')[0]);
            };

            return (
                <div className="flex-1 flex items-center justify-center bg-slate-900 p-6">
                    <div className="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                                <span className="text-white text-3xl font-black">OP</span>
                            </div>
                            <h1 className="text-2xl font-black text-slate-800">ObraPro</h1>
                            <p className="text-slate-500 text-sm">GestiÃ³n de obras simplificada</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && <input placeholder="Tu nombre" value={nombre} onChange={e => setNombre(e.target.value)} className="w-full" />}
                            <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} required className="w-full" />
                            <input type="password" placeholder="ContraseÃ±a" required className="w-full" />
                            <button type="submit" className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg">{isLogin ? 'INICIAR SESIÃ“N' : 'CREAR CUENTA'}</button>
                        </form>

                        <p className="text-center mt-6 text-sm text-slate-500">
                            {isLogin ? 'Â¿No tienes cuenta? ' : 'Â¿Ya tienes cuenta? '}
                            <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 font-bold">{isLogin ? 'RegÃ­strate' : 'Inicia sesiÃ³n'}</button>
                        </p>
                    </div>
                </div>
            );
        }

        function VistaLista({ titulo, items, onBack, onEdit, onDelete, renderItem }) {
            return (
                <main className="flex-1 overflow-y-auto no-scrollbar p-4 bg-slate-100">
                    <div className="flex items-center gap-4 mb-4">
                        <button onClick={onBack} className="p-2 bg-white rounded-full">â†</button>
                        <h2 className="text-xl font-bold text-slate-800">{titulo}</h2>
                    </div>
                    {items.length === 0 ? <p className="text-center text-slate-400 py-10">No hay registros</p> : items.map(item => (
                        <div key={item.id} className="ios-card p-4 mb-3 flex justify-between items-center">
                            {renderItem(item)}
                            <div className="item-actions ml-4">
                                <button onClick={() => onEdit(item)} className="btn-icon btn-edit" title="Editar">âœï¸</button>
                                <button onClick={() => onDelete(item.id)} className="btn-icon btn-delete" title="Eliminar">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                    ))}
                </main>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
