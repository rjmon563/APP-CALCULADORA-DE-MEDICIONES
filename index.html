<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <title>ObraPro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overscroll-behavior: none;
            background: #0f172a;
            user-select: none;
            -webkit-user-select: none;
        }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .app-container { height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease; }
        .animate-slide-up { animation: slideUp 0.3s ease; }
        
        .ios-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        
        .touch-key {
            min-height: 56px;
            touch-action: manipulation;
            transition: all 0.1s;
            border: none;
            font-weight: 600;
            background: white;
            border-radius: 12px;
        }
        .touch-key:active { transform: scale(0.92); background: #e2e8f0; }
        
        .calc-display {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            font-family: 'SF Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: #0f172a;
            text-align: right;
            min-height: 64px;
            word-break: break-all;
        }
        
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 24px 24px 0 0;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            max-height: 90vh;
            overflow-y: auto;
        }
        .bottom-sheet.open { transform: translateY(0); }
        
        .sheet-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 199;
        }
        .sheet-overlay.open { opacity: 1; pointer-events: auto; }
        
        .fab {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            z-index: 100;
            border: none;
        }
        .fab:active { transform: scale(0.9); }
        
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }
        
        .obra-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: white;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 600;
            color: #475569;
            border: 2px solid #e2e8f0;
            white-space: nowrap;
        }
        .obra-chip.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        input, select {
            font-size: 16px !important;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 12px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
        }
        input:focus, select:focus {
            border-color: #3b82f6;
            background: white;
        }
        
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .photo-thumb { aspect-ratio: 1; border-radius: 12px; overflow: hidden; position: relative; background: #f1f5f9; }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-thumb .delete {
            position: absolute; top: 4px; right: 4px;
            width: 24px; height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; border: none;
        }
        
        .photo-modal {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s;
        }
        .photo-modal.open { opacity: 1; pointer-events: auto; }
        .photo-modal img { max-width: 90%; max-height: 80vh; border-radius: 12px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 16px; }
        .menu-item {
            aspect-ratio: 1; background: white;
            border-radius: 16px;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            gap: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .menu-item svg { width: 28px; height: 28px; color: #3b82f6; }
        .menu-item span { font-size: 11px; font-weight: 600; color: #475569; text-align: center; }
        
        .badge {
            display: inline-flex; align-items: center;
            padding: 4px 10px; border-radius: 20px;
            font-size: 10px; font-weight: 700; text-transform: uppercase;
        }
        .badge-pendiente { background: #fef3c7; color: #d97706; }
        .badge-completado { background: #d1fae5; color: #059669; }
    </style>
</head>
<body>
    <div id="root" class="app-container safe-top safe-bottom"></div>
    <div id="toast" class="toast"></div>

    <script>
        window.showToast = (msg, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 2500);
        };
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // Database simple con localStorage
        const DB = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            saveItem: (store, item) => {
                const data = DB.get(store);
                data.unshift(item);
                DB.set(store, data);
                return item;
            },
            deleteItem: (store, id) => {
                const data = DB.get(store).filter(i => i.id !== id);
                DB.set(store, data);
            }
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [obraActual, setObraActual] = useState(null);
            const [obras, setObras] = useState([]);
            const [vista, setVista] = useState('dashboard');
            const [showForm, setShowForm] = useState(false);
            const [showObraForm, setShowObraForm] = useState(false);
            const [showPhotoModal, setShowPhotoModal] = useState(null);
            const [formType, setFormType] = useState('medicion');
            
            const [mediciones, setMediciones] = useState([]);
            const [horas, setHoras] = useState([]);
            const [materiales, setMateriales] = useState([]);
            const [personal, setPersonal] = useState([]);
            const [gastos, setGastos] = useState([]);
            
            const [medForm, setMedForm] = useState({ tipo: 'Tabique', desc: '', valor: '', mult: '', unidad: 'm', precio: '' });
            const [horaForm, setHoraForm] = useState({ desc: '', inicio: '', fin: '', fecha: new Date().toISOString().split('T')[0], descanso: 0, fotos: [] });
            const [obraForm, setObraForm] = useState({ nombre: '', cliente: '', direccion: '', presupuesto: '' });
            const [matForm, setMatForm] = useState({ nombre: '', cantidad: '', unidad: '', precioUnitario: '', proveedor: '' });
            const [persForm, setPersForm] = useState({ nombre: '', cargo: '', telefono: '', salarioDia: '' });
            const [gastoForm, setGastoForm] = useState({ concepto: '', monto: '', categoria: 'material', fecha: new Date().toISOString().split('T')[0] });

            useEffect(() => {
                const savedUser = localStorage.getItem('obrapro_user');
                const savedObras = DB.get('obras');
                
                if (savedUser) setUser(JSON.parse(savedUser));
                setObras(savedObras);
                if (savedObras.length > 0 && !obraActual) {
                    setObraActual(savedObras[0]);
                    cargarDatosObra(savedObras[0].id);
                }
                setLoading(false);
            }, []);

            const cargarDatosObra = (obraId) => {
                const meds = DB.get('mediciones').filter(m => m.obraId === obraId);
                const hrs = DB.get('horas').filter(h => h.obraId === obraId);
                const mats = DB.get('materiales').filter(m => m.obraId === obraId);
                const pers = DB.get('personal').filter(p => p.obraId === obraId);
                const gast = DB.get('gastos').filter(g => g.obraId === obraId);
                
                setMediciones(meds);
                setHoras(hrs);
                setMateriales(mats);
                setPersonal(pers);
                setGastos(gast);
            };

            const login = (email, nombre) => {
                const newUser = { id: Date.now(), email, nombre };
                localStorage.setItem('obrapro_user', JSON.stringify(newUser));
                setUser(newUser);
                window.showToast('¬°Bienvenido!');
            };

            const logout = () => {
                localStorage.removeItem('obrapro_user');
                setUser(null);
            };

            const crearObra = () => {
                if (!obraForm.nombre) {
                    window.showToast('Ingresa un nombre', 'error');
                    return;
                }
                const nueva = {
                    id: 'obra_' + Date.now(),
                    ...obraForm,
                    fechaCreacion: new Date().toLocaleDateString('es-ES')
                };
                DB.saveItem('obras', nueva);
                setObras([nueva, ...obras]);
                setObraActual(nueva);
                setShowObraForm(false);
                setObraForm({ nombre: '', cliente: '', direccion: '', presupuesto: '' });
                cargarDatosObra(nueva.id);
                window.showToast('Obra creada');
            };

            const clickTecla = (t) => {
                if (t === 'C') setMedForm(p => ({...p, valor: ''}));
                else if (t === '‚Üê') setMedForm(p => ({...p, valor: p.valor.slice(0, -1)}));
                else if (t === '+') setMedForm(p => ({...p, valor: p.valor.endsWith('+') ? p.valor : p.valor + '+'}));
                else setMedForm(p => ({...p, valor: p.valor + t}));
            };

            const guardarMedicion = () => {
                if (!obraActual || !medForm.valor) return;
                const suma = medForm.valor.split('+').reduce((a, b) => a + (parseFloat(b) || 0), 0);
                const mult = parseFloat(medForm.mult) || 0;
                const precio = parseFloat(medForm.precio) || 0;
                
                DB.saveItem('mediciones', {
                    id: 'med_' + Date.now(),
                    obraId: obraActual.id,
                    tipo: medForm.tipo,
                    desc: medForm.desc || 'Sin descripci√≥n',
                    valor: medForm.valor,
                    mult,
                    unidad: medForm.unidad,
                    totalL: suma.toFixed(2),
                    totalS: (suma * mult).toFixed(2),
                    precio,
                    totalPrecio: (suma * mult * precio).toFixed(2),
                    fecha: new Date().toLocaleDateString('es-ES')
                });
                
                cargarDatosObra(obraActual.id);
                setMedForm({ tipo: medForm.tipo, desc: '', valor: '', mult: '', unidad: medForm.unidad, precio: '' });
                setShowForm(false);
                window.showToast('Medici√≥n guardada');
            };

            const guardarHora = () => {
                if (!obraActual || !horaForm.inicio || !horaForm.fin) return;
                
                const h1 = new Date(`2000-01-01T${horaForm.inicio}`);
                const h2 = new Date(`2000-01-01T${horaForm.fin}`);
                let horas = (h2 - h1) / 3600000 - (parseFloat(horaForm.descanso) || 0) / 60;
                
                if (horas <= 0) {
                    window.showToast('Hora fin debe ser mayor', 'error');
                    return;
                }

                DB.saveItem('horas', {
                    id: 'hora_' + Date.now(),
                    obraId: obraActual.id,
                    desc: horaForm.desc || 'Sin descripci√≥n',
                    inicio: horaForm.inicio,
                    fin: horaForm.fin,
                    fecha: horaForm.fecha,
                    descanso: horaForm.descanso,
                    total: horas.toFixed(2),
                    fotos: horaForm.fotos.length
                });
                
                // Guardar fotos
                horaForm.fotos.forEach((foto, i) => {
                    DB.saveItem('fotos', {
                        id: `foto_${Date.now()}_${i}`,
                        horaId: 'hora_' + Date.now(),
                        obraId: obraActual.id,
                        data: foto
                    });
                });
                
                cargarDatosObra(obraActual.id);
                setHoraForm({ desc: '', inicio: '', fin: '', fecha: new Date().toISOString().split('T')[0], descanso: 0, fotos: [] });
                setShowForm(false);
                window.showToast('Horas guardadas');
            };

            const guardarMaterial = () => {
                if (!obraActual || !matForm.nombre) return;
                DB.saveItem('materiales', {
                    id: 'mat_' + Date.now(),
                    obraId: obraActual.id,
                    ...matForm,
                    total: (parseFloat(matForm.cantidad) * parseFloat(matForm.precioUnitario || 0)).toFixed(2),
                    fecha: new Date().toLocaleDateString('es-ES')
                });
                cargarDatosObra(obraActual.id);
                setMatForm({ nombre: '', cantidad: '', unidad: '', precioUnitario: '', proveedor: '' });
                setShowForm(false);
                window.showToast('Material guardado');
            };

            const guardarPersonal = () => {
                if (!obraActual || !persForm.nombre) return;
                DB.saveItem('personal', {
                    id: 'pers_' + Date.now(),
                    obraId: obraActual.id,
                    ...persForm,
                    fechaRegistro: new Date().toLocaleDateString('es-ES')
                });
                cargarDatosObra(obraActual.id);
                setPersForm({ nombre: '', cargo: '', telefono: '', salarioDia: '' });
                setShowForm(false);
                window.showToast('Personal guardado');
            };

            const guardarGasto = () => {
                if (!obraActual || !gastoForm.concepto) return;
                DB.saveItem('gastos', {
                    id: 'gasto_' + Date.now(),
                    obraId: obraActual.id,
                    ...gastoForm
                });
                cargarDatosObra(obraActual.id);
                setGastoForm({ concepto: '', monto: '', categoria: 'material', fecha: new Date().toISOString().split('T')[0] });
                setShowForm(false);
                window.showToast('Gasto guardado');
            };

            const tomarFoto = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.capture = 'environment';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onloadend = () => setHoraForm(p => ({...p, fotos: [...p.fotos, reader.result]}));
                    reader.readAsDataURL(file);
                };
                input.click();
            };

            const eliminarFoto = (idx) => setHoraForm(p => ({...p, fotos: p.fotos.filter((_, i) => i !== idx)}));

            const eliminarItem = (tipo, id) => {
                if (!confirm('¬øEliminar?')) return;
                DB.deleteItem(tipo, id);
                cargarDatosObra(obraActual.id);
                window.showToast('Eliminado');
            };

            const exportarPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFillColor(15, 23, 42);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.text(obraActual?.nombre || 'INFORME', 105, 20, { align: 'center' });
                doc.setFontSize(10);
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 105, 32, { align: 'center' });
                
                let y = 50;
                
                if (mediciones.length > 0) {
                    doc.setFontSize(14);
                    doc.text('MEDICIONES', 14, y);
                    y += 10;
                    doc.autoTable({
                        head: [['Fecha', 'Tipo', 'Descripci√≥n', 'm¬≤', 'Total']],
                        body: mediciones.map(m => [m.fecha, m.tipo, m.desc.substring(0, 25), m.totalS, m.totalPrecio ? '$' + m.totalPrecio : '-']),
                        startY: y,
                        theme: 'striped',
                        headStyles: { fillColor: [37, 99, 235] }
                    });
                    y = doc.lastAutoTable.finalY + 15;
                }
                
                if (horas.length > 0) {
                    doc.setFontSize(14);
                    doc.text('HORAS', 14, y);
                    y += 10;
                    doc.autoTable({
                        head: [['Fecha', 'Descripci√≥n', 'Horario', 'Total']],
                        body: horas.map(h => [h.fecha, h.desc.substring(0, 30), `${h.inicio}-${h.fin}`, h.total + 'h']),
                        startY: y,
                        theme: 'striped',
                        headStyles: { fillColor: [16, 185, 129] }
                    });
                }
                
                doc.save(`Obra_${obraActual?.nombre}_${new Date().toISOString().split('T')[0]}.pdf`);
                window.showToast('PDF generado');
            };

            const stats = {
                totalML: mediciones.reduce((a, b) => a + parseFloat(b.totalL), 0),
                totalM2: mediciones.reduce((a, b) => a + parseFloat(b.totalS), 0),
                totalPrecio: mediciones.reduce((a, b) => a + parseFloat(b.totalPrecio || 0), 0),
                totalHoras: horas.reduce((a, b) => a + parseFloat(b.total), 0),
                totalMateriales: materiales.reduce((a, b) => a + parseFloat(b.total || 0), 0),
                totalGastos: gastos.reduce((a, b) => a + parseFloat(b.monto || 0), 0)
            };

            if (loading) {
                return (
                    <div className="flex-1 flex items-center justify-center text-white">
                        <div className="text-center">
                            <div className="w-20 h-20 bg-blue-500 rounded-2xl mx-auto mb-4 flex items-center justify-center animate-fade-in">
                                <span className="text-3xl font-black">OP</span>
                            </div>
                            <p className="font-bold text-lg">ObraPro</p>
                        </div>
                    </div>
                );
            }

            if (!user) {
                return <LoginScreen onLogin={login} />;
            }

            return (
                <>
                    <header className="bg-slate-900 text-white px-4 py-3">
                        <div className="flex justify-between items-center mb-3">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center">
                                    <span className="font-black text-lg">OP</span>
                                </div>
                                <div>
                                    <h1 className="font-black text-sm">ObraPro</h1>
                                    <p className="text-xs text-slate-400">Buen Camino</p>
                                </div>
                            </div>
                            <button onClick={logout} className="text-xs text-slate-400">Salir</button>
                        </div>
                        
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            {obras.map(o => (
                                <button key={o.id} onClick={() => { setObraActual(o); cargarDatosObra(o.id); }} className={`obra-chip ${obraActual?.id === o.id ? 'active' : ''}`}>
                                    {o.nombre}
                                </button>
                            ))}
                            <button onClick={() => setShowObraForm(true)} className="obra-chip bg-slate-800 text-slate-400 border-slate-700 text-xs">+ Nueva</button>
                        </div>
                    </header>

                    {vista === 'dashboard' && (
                        <main className="flex-1 overflow-y-auto no-scrollbar p-4">
                            {!obraActual ? (
                                <div className="text-center text-white py-20">
                                    <p className="mb-4">Crea tu primera obra</p>
                                    <button onClick={() => setShowObraForm(true)} className="px-6 py-3 bg-blue-600 rounded-xl font-bold">Crear Obra</button>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="ios-card p-4 bg-gradient-to-br from-blue-600 to-purple-600 text-white">
                                        <p className="text-xs text-blue-200 mb-1">{obraActual.nombre}</p>
                                        <div className="grid grid-cols-2 gap-4 mt-2">
                                            <div>
                                                <p className="text-2xl font-black">{stats.totalML.toFixed(2)}</p>
                                                <p className="text-xs text-blue-200">metros</p>
                                            </div>
                                            <div>
                                                <p className="text-2xl font-black">{stats.totalHoras.toFixed(2)}h</p>
                                                <p className="text-xs text-blue-200">horas</p>
                                            </div>
                                        </div>
                                        {stats.totalPrecio > 0 && (
                                            <p className="mt-3 pt-3 border-t border-white/20 text-lg font-bold">${stats.totalPrecio.toFixed(2)}</p>
                                        )}
                                    </div>

                                    <div className="menu-grid">
                                        <div className="menu-item" onClick={() => setVista('mediciones')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
                                            <span>Mediciones</span>
                                            {mediciones.length > 0 && <span className="absolute top-1 right-1 bg-blue-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{mediciones.length}</span>}
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('horas')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                            <span>Horas</span>
                                            {horas.length > 0 && <span className="absolute top-1 right-1 bg-emerald-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">{horas.length}</span>}
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('materiales')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                                            <span>Materiales</span>
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('personal')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                            <span>Personal</span>
                                        </div>
                                        <div className="menu-item" onClick={() => setVista('gastos')}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                            <span>Gastos</span>
                                        </div>
                                        <div className="menu-item" onClick={exportarPDF}>
                                            <svg fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                            <span>PDF</span>
                                        </div>
                                    </div>

                                    {mediciones.length > 0 && (
                                        <div className="ios-card p-4">
                                            <h3 className="text-sm font-bold text-slate-500 mb-3">√öltimas mediciones</h3>
                                            {mediciones.slice(0, 3).map(m => (
                                                <div key={m.id} className="flex justify-between items-center py-2 border-b last:border-0">
                                                    <div>
                                                        <span className="text-xs font-bold text-blue-500">{m.tipo}</span>
                                                        <p className="text-sm font-medium">{m.desc}</p>
                                                    </div>
                                                    <div className="text-right">
                                                        <p className="font-bold">{m.totalL} ml</p>
                                                        <p className="text-xs text-emerald-600">{m.totalS} m¬≤</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </main>
                    )}

                    {vista === 'mediciones' && (
                        <VistaLista 
                            titulo="Mediciones" 
                            items={mediciones} 
                            onBack={() => setVista('dashboard')}
                            renderItem={m => (
                                <div className="flex justify-between items-center p-4 bg-white rounded-xl mb-2">
                                    <div>
                                        <span className="text-xs font-bold text-blue-500 bg-blue-50 px-2 py-0.5 rounded">{m.tipo}</span>
                                        <p className="font-medium text-sm mt-1">{m.desc}</p>
                                        <p className="text-xs text-slate-400">{m.fecha}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-lg">{m.totalL} ml</p>
                                        <p className="text-xs text-emerald-600">{m.totalS} m¬≤</p>
                                        {m.precio > 0 && <p className="text-xs text-amber-600">${m.totalPrecio}</p>}
                                    </div>
                                </div>
                            )}
                        />
                    )}

                    {vista === 'horas' && (
                        <VistaLista 
                            titulo="Horas Trabajadas" 
                            items={horas}
                            onBack={() => setVista('dashboard')}
                            renderItem={h => (
                                <div className="p-4 bg-white rounded-xl mb-2">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="font-medium">{h.desc}</p>
                                            <p className="text-xs text-slate-400">{h.fecha} ‚Ä¢ {h.inicio}-{h.fin}</p>
                                            {h.fotos > 0 && <p className="text-xs text-blue-500 mt-1">üì∑ {h.fotos} fotos</p>}
                                        </div>
                                        <p className="font-bold text-emerald-600 text-xl">{h.total}h</p>
                                    </div>
                                </div>
                            )}
                        />
                    )}

                    {vista === 'materiales' && (
                        <VistaLista 
                            titulo="Materiales" 
                            items={materiales}
                            onBack={() => setVista('dashboard')}
                            renderItem={m => (
                                <div className="flex justify-between items-center p-4 bg-white rounded-xl mb-2">
                                    <div>
                                        <p className="font-medium">{m.nombre}</p>
                                        <p className="text-xs text-slate-400">{m.cantidad} {m.unidad} ‚Ä¢ {m.proveedor}</p>
                                    </div>
                                    <p className="font-bold">${m.total}</p>
                                </div>
                            )}
                        />
                    )}

                    {vista === 'personal' && (
                        <VistaLista 
                            titulo="Personal" 
                            items={personal}
                            onBack={() => setVista('dashboard')}
                            renderItem={p => (
                                <div className="flex justify-between items-center p-4 bg-white rounded-xl mb-2">
                                    <div>
                                        <p className="font-medium">{p.nombre}</p>
                                        <p className="text-xs text-slate-400">{p.cargo} ‚Ä¢ {p.telefono}</p>
                                    </div>
                                    <p className="text-sm font-bold text-blue-600">${p.salarioDia}/d√≠a</p>
                                </div>
                            )}
                        />
                    )}

                    {vista === 'gastos' && (
                        <VistaLista 
                            titulo="Gastos" 
                            items={gastos}
                            onBack={() => setVista('dashboard')}
                            renderItem={g => (
                                <div className="flex justify-between items-center p-4 bg-white rounded-xl mb-2">
                                    <div>
                                        <p className="font-medium">{g.concepto}</p>
                                        <p className="text-xs text-slate-400">{g.fecha} ‚Ä¢ {g.categoria}</p>
                                    </div>
                                    <p className="font-bold text-red-500">-${g.monto}</p>
                                </div>
                            )}
                        />
                    )}

                    {obraActual && vista === 'dashboard' && (
                        <button onClick={() => setShowForm(true)} className="fab">
                            <svg width="24" height="24" fill="none" stroke="white" strokeWidth="2" viewBox="0 0 24 24"><path d="M12 4v16m8-8H4"/></svg>
                        </button>
                    )}

                    {/* Modal Nueva Obra */}
                    <div className={`sheet-overlay ${showObraForm ? 'open' : ''}`} onClick={() => setShowObraForm(false)}></div>
                    <div className={`bottom-sheet ${showObraForm ? 'open' : ''}`}>
                        <div className="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-4"></div>
                        <h2 className="text-xl font-bold mb-4">Nueva Obra</h2>
                        <div className="space-y-3">
                            <input placeholder="Nombre *" value={obraForm.nombre} onChange={e => setObraForm({...obraForm, nombre: e.target.value})} />
                            <input placeholder="Cliente" value={obraForm.cliente} onChange={e => setObraForm({...obraForm, cliente: e.target.value})} />
                            <input placeholder="Direcci√≥n" value={obraForm.direccion} onChange={e => setObraForm({...obraForm, direccion: e.target.value})} />
                            <input placeholder="Presupuesto $" type="number" value={obraForm.presupuesto} onChange={e => setObraForm({...obraForm, presupuesto: e.target.value})} />
                            <button onClick={crearObra} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">CREAR OBRA</button>
                        </div>
                    </div>

                    {/* Modal Formulario */}
                    <div className={`sheet-overlay ${showForm ? 'open' : ''}`} onClick={() => setShowForm(false)}></div>
                    <div className={`bottom-sheet ${showForm ? 'open' : ''}`}>
                        <div className="w-12 h-1 bg-slate-300 rounded-full mx-auto mb-4"></div>
                        
                        <div className="flex gap-2 mb-4 overflow-x-auto">
                            {['medicion', 'horas', 'material', 'personal', 'gasto'].map(t => (
                                <button key={t} onClick={() => setFormType(t)} className={`px-3 py-2 rounded-full text-xs font-bold capitalize ${formType === t ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-600'}`}>
                                    {t}
                                </button>
                            ))}
                        </div>

                        {formType === 'medicion' && (
                            <div className="space-y-3">
                                <select value={medForm.tipo} onChange={e => setMedForm({...medForm, tipo: e.target.value})} className="font-bold">
                                    <option>Tabique</option><option>Techo</option><option>Caj√≥n ML</option><option>Tabica</option><option>Cantonera</option><option>Muro</option><option>Piso</option>
                                </select>
                                <input placeholder="Descripci√≥n" value={medForm.desc} onChange={e => setMedForm({...medForm, desc: e.target.value})} />
                                <div className="calc-display">{medForm.valor || "0"} {medForm.unidad}</div>
                                <div className="grid grid-cols-4 gap-2">
                                    {['7','8','9','+','4','5','6','‚Üê','1','2','3','C','.','0'].map(t => (
                                        <button key={t} onClick={() => clickTecla(t)} className={`touch-key ${['+','‚Üê','C'].includes(t) ? 'bg-slate-200' : ''}`}>{t === '‚Üê' ? '‚å´' : t}</button>
                                    ))}
                                </div>
                                <div className="flex gap-2">
                                    <input placeholder="Altura/Ancho" type="number" value={medForm.mult} onChange={e => setMedForm({...medForm, mult: e.target.value})} />
                                    <input placeholder="Precio/m¬≤" type="number" value={medForm.precio} onChange={e => setMedForm({...medForm, precio: e.target.value})} />
                                </div>
                                <button onClick={guardarMedicion} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">GUARDAR</button>
                            </div>
                        )}

                        {formType === 'horas' && (
                            <div className="space-y-3">
                                <input placeholder="Descripci√≥n de la tarea" value={horaForm.desc} onChange={e => setHoraForm({...horaForm, desc: e.target.value})} />
                                <div className="grid grid-cols-2 gap-2">
                                    <input type="time" value={horaForm.inicio} onChange={e => setHoraForm({...horaForm, inicio: e.target.value})} />
                                    <input type="time" value={horaForm.fin} onChange={e => setHoraForm({...horaForm, fin: e.target.value})} />
                                </div>
                                <input type="number" placeholder="Descanso (min)" value={horaForm.descanso} onChange={e => setHoraForm({...horaForm, descanso: e.target.value})} />
                                
                                {horaForm.fotos.length > 0 && (
                                    <div className="photo-grid">
                                        {horaForm.fotos.map((f, i) => (
                                            <div key={i} className="photo-thumb">
                                                <img src={f} />
                                                <button onClick={() => eliminarFoto(i)} className="delete">√ó</button>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                
                                <button onClick={tomarFoto} className="w-full py-3 bg-amber-500 text-white font-bold rounded-xl flex items-center justify-center gap-2">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3"/></svg>
                                    {horaForm.fotos.length > 0 ? 'Agregar otra foto' : 'Tomar foto'}
                                </button>
                                
                                <button onClick={guardarHora} className="w-full py-3 bg-emerald-600 text-white font-bold rounded-xl">GUARDAR HORAS</button>
                            </div>
                        )}

                        {formType === 'material' && (
                            <div className="space-y-3">
                                <input placeholder="Nombre del material" value={matForm.nombre} onChange={e => setMatForm({...matForm, nombre: e.target.value})} />
                                <div className="flex gap-2">
                                    <input placeholder="Cantidad" type="number" value={matForm.cantidad} onChange={e => setMatForm({...matForm, cantidad: e.target.value})} />
                                    <input placeholder="Unidad" value={matForm.unidad} onChange={e => setMatForm({...matForm, unidad: e.target.value})} className="w-24" />
                                </div>
                                <input placeholder="Precio unitario" type="number" value={matForm.precioUnitario} onChange={e => setMatForm({...matForm, precioUnitario: e.target.value})} />
                                <input placeholder="Proveedor" value={matForm.proveedor} onChange={e => setMatForm({...matForm, proveedor: e.target.value})} />
                                <button onClick={guardarMaterial} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">GUARDAR MATERIAL</button>
                            </div>
                        )}

                        {formType === 'personal' && (
                            <div className="space-y-3">
                                <input placeholder="Nombre completo" value={persForm.nombre} onChange={e => setPersForm({...persForm, nombre: e.target.value})} />
                                <input placeholder="Cargo" value={persForm.cargo} onChange={e => setPersForm({...persForm, cargo: e.target.value})} />
                                <input placeholder="Tel√©fono" value={persForm.telefono} onChange={e => setPersForm({...persForm, telefono: e.target.value})} />
                                <input placeholder="Salario por d√≠a" type="number" value={persForm.salarioDia} onChange={e => setPersForm({...persForm, salarioDia: e.target.value})} />
                                <button onClick={guardarPersonal} className="w-full py-3 bg-blue-600 text-white font-bold rounded-xl">GUARDAR PERSONAL</button>
                            </div>
                        )}

                        {formType === 'gasto' && (
                            <div className="space-y-3">
                                <input placeholder="Concepto" value={gastoForm.concepto} onChange={e => setGastoForm({...gastoForm, concepto: e.target.value})} />
                                <input placeholder="Monto" type="number" value={gastoForm.monto} onChange={e => setGastoForm({...gastoForm, monto: e.target.value})} />
                                <select value={gastoForm.categoria} onChange={e => setGastoForm({...gastoForm, categoria: e.target.value})}>
                                    <option value="material">Material</option>
                                    <option value="transporte">Transporte</option>
                                    <option value="comida">Comida</option>
                                    <option value="herramienta">Herramienta</option>
                                    <option value="otro">Otro</option>
                                </select>
                                <button onClick={guardarGasto} className="w-full py-3 bg-red-500 text-white font-bold rounded-xl">GUARDAR GASTO</button>
                            </div>
                        )}
                    </div>

                    {/* Visor de fotos */}
                    <div className={`photo-modal ${showPhotoModal ? 'open' : ''}`} onClick={() => setShowPhotoModal(null)}>
                        <button className="absolute top-4 right-4 text-white p-2 bg-black/50 rounded-full">‚úï</button>
                        {showPhotoModal && <img src={showPhotoModal} />}
                    </div>
                </>
            );
        }

        function LoginScreen({ onLogin }) {
            const [email, setEmail] = useState('');
            const [nombre, setNombre] = useState('');
            const [isLogin, setIsLogin] = useState(true);

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, nombre || email.split('@')[0]);
            };

            return (
                <div className="flex-1 flex items-center justify-center bg-slate-900 p-6">
                    <div className="w-full max-w-sm bg-white rounded-3xl p-8 shadow-2xl">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                                <span className="text-white text-3xl font-black">OP</span>
                            </div>
                            <h1 className="text-2xl font-black text-slate-800">ObraPro</h1>
                            <p className="text-slate-500 text-sm">Gesti√≥n de obras simplificada</p>
                        </div>

                        <form onSubmit={handleSubmit} className="space-y-4">
                            {!isLogin && (
                                <input 
                                    placeholder="Tu nombre" 
                                    value={nombre} 
                                    onChange={e => setNombre(e.target.value)}
                                    className="w-full"
                                />
                            )}
                            <input 
                                type="email" 
                                placeholder="Email" 
                                value={email} 
                                onChange={e => setEmail(e.target.value)}
                                required
                                className="w-full"
                            />
                            <input 
                                type="password" 
                                placeholder="Contrase√±a" 
                                required
                                className="w-full"
                            />
                            <button type="submit" className="w-full py-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-200">
                                {isLogin ? 'INICIAR SESI√ìN' : 'CREAR CUENTA'}
                            </button>
                        </form>

                        <p className="text-center mt-6 text-sm text-slate-500">
                            {isLogin ? '¬øNo tienes cuenta? ' : '¬øYa tienes cuenta? '}
                            <button onClick={() => setIsLogin(!isLogin)} className="text-blue-600 font-bold">
                                {isLogin ? 'Reg√≠strate' : 'Inicia sesi√≥n'}
                            </button>
                        </p>
                    </div>
                </div>
            );
        }

        function VistaLista({ titulo, items, onBack, renderItem }) {
            return (
                <main className="flex-1 overflow-y-auto no-scrollbar p-4 bg-slate-100">
                    <div className="flex items-center gap-4 mb-4">
                        <button onClick={onBack} className="p-2 bg-white rounded-full">‚Üê</button>
                        <h2 className="text-xl font-bold text-white">{titulo}</h2>
                    </div>
                    {items.length === 0 ? (
                        <p className="text-center text-slate-400 py-10">No hay registros</p>
                    ) : (
                        items.map(item => <div key={item.id}>{renderItem(item)}</div>)
                    )}
                </main>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
